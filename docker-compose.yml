# =============================================================================
# Archivematica Docker Compose
# =============================================================================
# 
# Based on: https://github.com/artefactual/archivematica/tree/qa/1.x/hack
#
# Exposed services:
#   - archivematica-dashboard: port 8000
#   - archivematica-storage-service: port 8001
#
# =============================================================================

volumes:
  mysql_data:
  elasticsearch_data:
  archivematica_storage_service_staging_data:
  archivematica_pipeline_data:
  archivematica_storage_service_location_data:

services:

  mysql:
    image: "percona/percona-server:8.4.6-6"
    command: "--character-set-server=utf8mb4 --collation-server=utf8mb4_0900_ai_ci"
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER:-archivematica}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - "mysql_data:/var/lib/mysql"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  elasticsearch:
    image: "docker.elastic.co/elasticsearch/elasticsearch:8.19.8"
    restart: unless-stopped
    environment:
      - "cluster.name=am-cluster"
      - "node.name=am-node"
      - "network.host=0.0.0.0"
      - "bootstrap.memory_lock=true"
      - "ES_JAVA_OPTS=-Xms${ES_HEAP_SIZE:-512m} -Xmx${ES_HEAP_SIZE:-512m}"
      - "discovery.type=single-node"
      - "xpack.security.enabled=false"
      - "xpack.security.transport.ssl.enabled=false"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: ["CMD-SHELL", "curl -fsSL http://localhost:9200/_cat/health?h=status | grep -q -E 'green|yellow'"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 25s
    volumes:
      - "elasticsearch_data:/usr/share/elasticsearch/data"

  gearmand:
    image: "artefactual/gearmand:1.1.22-alpine"
    command: "--queue-type=builtin"
    restart: unless-stopped

  clamavd:
    image: "clamav/clamav-debian:1.5.1-17"
    user: "clamav"
    entrypoint: "/init-unprivileged"
    restart: unless-stopped
    environment:
      CLAMD_CONF_MaxFileSize: ${CLAMAV_MAX_FILE_SIZE:-42M}
      CLAMD_CONF_MaxScanSize: ${CLAMAV_MAX_SCAN_SIZE:-42M}
      CLAMD_CONF_StreamMaxLength: ${CLAMAV_MAX_STREAM_LENGTH:-100M}
    volumes:
      - "archivematica_pipeline_data:/var/archivematica/sharedDirectory:ro"

  archivematica-mcp-server:
    build:
      context: "./submodules/archivematica"
      dockerfile: "hack/Dockerfile"
      args:
        TARGET: "archivematica-mcp-server"
        UBUNTU_VERSION: "24.04"
        PYTHON_VERSION: "3.10"
    restart: unless-stopped
    environment:
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_SETTINGS_MODULE: "archivematica.MCPServer.settings.common"
      ARCHIVEMATICA_MCPSERVER_CLIENT_USER: ${MYSQL_USER:-archivematica}
      ARCHIVEMATICA_MCPSERVER_CLIENT_PASSWORD: ${MYSQL_PASSWORD}
      ARCHIVEMATICA_MCPSERVER_CLIENT_HOST: "mysql"
      ARCHIVEMATICA_MCPSERVER_CLIENT_DATABASE: "MCP"
      ARCHIVEMATICA_MCPSERVER_MCPSERVER_MCPARCHIVEMATICASERVER: "gearmand:4730"
      ARCHIVEMATICA_MCPSERVER_SEARCH_ENABLED: ${AM_SEARCH_ENABLED:-true}
    volumes:
      - "./submodules/archivematica:/src"
      - "archivematica_pipeline_data:/var/archivematica/sharedDirectory:rw"
    depends_on:
      - mysql
      - gearmand

  archivematica-mcp-client:
    build:
      context: "./submodules/archivematica"
      dockerfile: "hack/Dockerfile"
      args:
        TARGET: "archivematica-mcp-client"
        UBUNTU_VERSION: "24.04"
        PYTHON_VERSION: "3.10"
    restart: unless-stopped
    environment:
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_SETTINGS_MODULE: "archivematica.MCPClient.settings.common"
      ARCHIVEMATICA_MCPCLIENT_CLIENT_USER: ${MYSQL_USER:-archivematica}
      ARCHIVEMATICA_MCPCLIENT_CLIENT_PASSWORD: ${MYSQL_PASSWORD}
      ARCHIVEMATICA_MCPCLIENT_CLIENT_HOST: "mysql"
      ARCHIVEMATICA_MCPCLIENT_CLIENT_DATABASE: "MCP"
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_ELASTICSEARCHSERVER: "http://elasticsearch:9200"
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_MCPARCHIVEMATICASERVER: "gearmand:4730"
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_SEARCH_ENABLED: ${AM_SEARCH_ENABLED:-true}
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_CAPTURE_CLIENT_SCRIPT_OUTPUT: ${AM_CAPTURE_CLIENT_SCRIPT_OUTPUT:-true}
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_CLAMAV_SERVER: "clamavd:3310"
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_CLAMAV_CLIENT_MAX_FILE_SIZE: ${CLAMAV_MAX_FILE_SIZE_MB:-42}
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_CLAMAV_CLIENT_MAX_SCAN_SIZE: ${CLAMAV_MAX_SCAN_SIZE_MB:-42}
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_CLAMAV_CLIENT_MAX_STREAM_LENGTH: ${CLAMAV_MAX_STREAM_LENGTH_MB:-100}
      ARCHIVEMATICA_MCPCLIENT_MCPCLIENT_CLAMAV_CLIENT_BACKEND: "clamdscanner"
    volumes:
      - "./submodules/archivematica:/src"
      - "archivematica_pipeline_data:/var/archivematica/sharedDirectory:rw"
    depends_on:
      - clamavd
      - mysql
      - gearmand
      - elasticsearch
      - archivematica-storage-service

  archivematica-dashboard:
    build:
      context: "./submodules/archivematica"
      dockerfile: "hack/Dockerfile"
      args:
        TARGET: "archivematica-dashboard"
        UBUNTU_VERSION: "24.04"
        PYTHON_VERSION: "3.10"
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      FORWARDED_ALLOW_IPS: "*"
      AM_GUNICORN_ACCESSLOG: "/dev/null"
      AM_GUNICORN_RELOAD: "false"
      AM_GUNICORN_BIND: "0.0.0.0:8000"
      AM_GUNICORN_WORKERS: ${AM_GUNICORN_WORKERS:-4}
      AM_GUNICORN_TIMEOUT: ${AM_GUNICORN_TIMEOUT:-172800}
      DJANGO_SETTINGS_MODULE: "archivematica.dashboard.settings.local"
      ARCHIVEMATICA_DASHBOARD_DASHBOARD_GEARMAN_SERVER: "gearmand:4730"
      ARCHIVEMATICA_DASHBOARD_DASHBOARD_ELASTICSEARCH_SERVER: "http://elasticsearch:9200"
      ARCHIVEMATICA_DASHBOARD_CLIENT_USER: ${MYSQL_USER:-archivematica}
      ARCHIVEMATICA_DASHBOARD_CLIENT_PASSWORD: ${MYSQL_PASSWORD}
      ARCHIVEMATICA_DASHBOARD_CLIENT_HOST: "mysql"
      ARCHIVEMATICA_DASHBOARD_CLIENT_DATABASE: "MCP"
      ARCHIVEMATICA_DASHBOARD_SEARCH_ENABLED: ${AM_SEARCH_ENABLED:-true}
    volumes:
      - "./submodules/archivematica:/src"
      - "archivematica_pipeline_data:/var/archivematica/sharedDirectory:rw"
    depends_on:
      elasticsearch:
        condition: service_healthy
      mysql:
        condition: service_healthy

  archivematica-storage-service:
    build:
      context: "./submodules/archivematica-storage-service"
      args:
        TARGET: "archivematica-storage-service"
        UBUNTU_VERSION: "24.04"
        PYTHON_VERSION: "3.10"
    restart: unless-stopped
    ports:
      - "8001:8000"
    environment:
      FORWARDED_ALLOW_IPS: "*"
      SS_GUNICORN_ACCESSLOG: "/dev/null"
      SS_GUNICORN_RELOAD: "false"
      SS_GUNICORN_BIND: "0.0.0.0:8000"
      SS_GUNICORN_WORKERS: ${SS_GUNICORN_WORKERS:-4}
      SS_GUNICORN_TIMEOUT: ${SS_GUNICORN_TIMEOUT:-172800}
      DJANGO_SETTINGS_MODULE: "archivematica.storage_service.storage_service.settings.local"
      SS_DB_URL: "mysql://${MYSQL_USER:-archivematica}:${MYSQL_PASSWORD}@mysql/SS"
      SS_GNUPG_HOME_PATH: "/var/archivematica/storage_service/.gnupg"
    volumes:
      - "./submodules/archivematica-storage-service:/src"
      - "archivematica_pipeline_data:/var/archivematica/sharedDirectory:rw"
      - "archivematica_storage_service_staging_data:/var/archivematica/storage_service:rw"
      - "archivematica_storage_service_location_data:/home:rw"
    depends_on:
      mysql:
        condition: service_healthy